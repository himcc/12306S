<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <script
            src="https://code.jquery.com/jquery-3.6.3.min.js"
            integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU="
            crossorigin="anonymous"></script>
    <style>
        a{
            color: #3b99fc;
        }
        .textRight{
            margin-right: 5px;
        }
        .inb{
            display: inline-block;
        }
        .tiketBtn{
            background-color: #007bff;
            border-color: #007bff;
            color: #fff;
            border-radius: 0.3rem;
            padding: 0.3rem 0.5rem;

            text-decoration: none;

        }
        div.nav a{
            text-decoration: none;
        }
        .mainbox{
            margin: 0 auto;
            width: fit-content;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
        }

        td,th {
            padding: 0;
        }

        .pure-table {
            border-collapse: collapse;
            border-spacing: 0;
            empty-cells: show;
            border: 1px solid #cbcbcb;
        }

        .pure-table caption {
            color: #000;
            font: italic 85%/1 arial,sans-serif;
            padding: 1em 0;
            text-align: center;
        }

        .pure-table td,.pure-table th {
            border-left: 1px solid #cbcbcb;
            border-bottom: 1px solid #cbcbcb;
            border-width: 0 0 1px 1px;
            font-size: inherit;
            margin: 0;
            overflow: visible;
            padding: .5em 1em;
        }

        .pure-table thead {
            background-color: #e0e0e0;
            color: #000;
            text-align: left;
            vertical-align: bottom;
        }

        .pure-table td {
            background-color: white;
        }

        .pure-table-odd td {
            background-color: #f2f2f2;
        }

        div.queryItem{
            display: inline-block;
            margin: 5px 15px;
        }

        .ccc{
            width: fit-content;
            margin: 0 auto;
        }
    </style>
    <title>12306S</title>
</head>
<body>
<script>

    var exp={};

    function setCookie(cname, cvalue, exdays) {
        console.log("setCookie "+cname+" : "+cvalue)
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires="+d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name)  == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    var changepwd={
        ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <input id="newpasswd" type="text" style="margin-right:10px;width:100px;">
        <button id="doChangePasswd" >修改密码</button>
        `,
        init:function (){
            $("#mainbox").children().remove();
            $("#mainbox").append(this.ele);
            $("#doChangePasswd").click(function (){
                var newpasswd = $("#newpasswd").val();
                if(newpasswd.length>0){
                    var p = this;
                    $.post("/chgpwd",{"password":newpasswd},function(data,status,xhr){
                        if(data.code==10000){
                            $("#mainbox").children().remove();
                            $("#mainbox").append("密码修改成功");
                        }else{
                            $("#tip").text("注册失败");
                            console.log(data.msg)
                        }
                    },"json");
                }else{
                    $("#tip").text("密码不能为空");
                }
            });
        }
    };
    function chgpwd(){
        changepwd.init();
    };


    var adminOp = {
        ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="adminOpBox"></div>
        `,
        btnClick:function (uid,newRole){
            var p = this;
            var url = "/admin/roleswitch?uid="+uid+"&newRole="+newRole;
            $.get(url,function (data,status,xhr){
                if(data.code==10000){
                    p.init();
                }else{
                    $("#tip").text("角色变更失败");
                    console.log(data.msg)
                }
            },"json");
        },
        handleAllUser:function(data,status,xhr){
            if(data.code==10000){
                var tablePre = `
                    <table border="1">
                      <tr>
                        <th>用户名</th>
                        <th>角色</th>
                        <th></th>
                      </tr>`;
                var tr_arr = [];
                for(var x of data.data){
                    if(x.username=='root'){
                        continue;
                    }
                    var rr=x.sysRole==0?'admin':'普通用户';
                    var newrr = x.sysRole==1?'成为:admin':'成为:普通用户';
                    tr_arr.push('<tr><td>'+x.username+'</td><td>'+rr+'</td><td><button onclick="adminOp.btnClick('+x.id+','+(x.sysRole==0?1:0)+')">'+newrr+'</button></td></tr>');
                }
                $("#adminOpBox").append(tablePre+tr_arr.join(" ")+"</table>");
                // $("#adminOpBox").text(JSON.stringify(data));
            }else{
                $("#tip").text("用户获取失败");
                console.log(data.msg)
            }
        },
        init: function (){
            var p = this;
            $("#mainbox").children().remove();
            $("#mainbox").append(this.ele);
            $.get("/admin/getalluser",p.handleAllUser,"json");
        }
    };




    var stationOp = {
        init_ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="opBox"></div>
        `,
        init:function (){
            var p = this;
            $("#mainbox").children().remove();

            $("#mainbox").append(this.init_ele);
            $.get("/admin/getallstation",p.show,"json");
        },
        show:function (data,status,xhr){
            // $("#tip").text(JSON.stringify(this));         this is ajax object
            // $("#tip").text(JSON.stringify(stationOp));    stationOp is available

            if(data.code==10000){
                var tablePre = `
                    <table border="1">
                      <tr>
                        <th>车站</th>
                        <th>城市</th>
                      </tr>`;
                var tr_arr = [];
                for(var x of data.data){
                    tr_arr.push('<tr><td class="stationName">'+x.stationName+'</td><td>'+x.cityName+'</td></tr>');
                }
                $("#opBox").append(tablePre+tr_arr.join(" ")+"</table>");

                $("#opBox").append("<hr>");

                var add_ele = `
                车站名：<input id="stationName" type="text" style="margin-right:10px;width:100px;">
                城市名：<input id="cityName" type="text" style="margin-right:10px;width:100px;">
                <button id="doAdd" >添加</button>
                `;

                $("#opBox").append(add_ele);

                $("#doAdd").click(stationOp.addStation);

            }else{
                $("#tip").text("车站获取失败");
                console.log(data.msg)
            }
        },
        addStation: function (){
            var stationName = $("#stationName").val();
            var cityName = $("#cityName").val();
            if(stationName.length<1){
                $("#tip").text("车站名不能为空");
                return;
            }
            if(stationName.charAt(stationName.length-1)!='站'){
                $("#tip").text("车站名需以【站】为结尾");
                return;
            }
            if(cityName.length<1){
                $("#tip").text("城市名不能为空");
                return;
            }
            if(cityName.charAt(cityName.length-1)=='站'){
                $("#tip").text("城市名不能以【站】为结尾");
                return;
            }
            var duplicateStations = $(".stationName").filter(function (){
                return $(this).text()==stationName;
            })
            if(duplicateStations.length>0){
                $("#tip").text("车站名不可以重复");
                return;
            }else{
                $.post("/admin/addstation",{"stationName":stationName,"cityName":cityName},stationOp.postStation,"json");
            }
        },
        postStation:function (data,status,xhr){
            if(data.code==10000){
                stationOp.init();
            }else{
                $("#tip").text("车站添加失败");
                console.log(data.msg)
            }
        },
    };


    var trainAdd = {
        init_ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="opBox"></div>
        `,
        maxTime:"",
        stations:new Map(),
        stationData:[],
        carData:[],
        init:function (){
            trainAdd.maxTime="";
            trainAdd.stations=new Map();
            trainAdd.stationData=[];
            trainAdd.carData=[];
            var p = this;
            $("#mainbox").children().remove();

            $("#mainbox").append(this.init_ele);

            $.get("/admin/getallstation",function (data,status,xhr){
                if(data.code==10000){
                    var station_arr = [];
                    for(var x of data.data){
                        station_arr.push(x.stationName);
                    }
                    trainAdd.init2(station_arr);
                }else{
                    $("#tip").text("车站获取失败");
                    console.log(data.msg)
                }
            },"json");
        },
        addCar:function (){
            $("#tip").text(" ").append("<span>&nbsp;</span>");;
            var num = parseInt($("#seatNum").val());
            if(num<1 || isNaN(num)){
                $("#tip").text("座位数量未设置");
                return;
            }
            var a = $("#seatTypeSelect").find("option:selected").text();
            var b = $("#seatTypeSelect").val();

            var no = $("#seatBody").children().length+1;

            $("#seatBody").append('<tr><td>'+no+'</td><td>'+b+'</td><td>'+num+'</td></tr>');

            trainAdd.carData.push({"id":no,"seatType":b,"seatNum":num});
        },
        addStation:function (){
            $("#tip").text(" ").append("<span>&nbsp;</span>");;
            var daoTime = $("#daoTime").val();
            var chuTime = $("#chuTime").val();
            var daoDay = parseInt($("#daoDay").val());
            var chuDay = parseInt($("#chuDay").val());

            if(daoDay<1 ||daoDay>9 || chuDay<1 || chuDay>9){
                $("#tip").text("站点的 到站天数 和 发车天数 应该在 0~9");
                return;
            }
            if(daoTime==''){
                $("#tip").text("到站时间未设置");
                return;
            }
            if(chuTime==''){
                $("#tip").text("发车时间未设置");
                return;
            }
            if((daoDay+' '+daoTime)>(chuDay+' '+chuTime)){
                $("#tip").text("发车时间 早于 到站时间");
                return;
            }
            if(trainAdd.maxTime>=(daoDay+' '+daoTime)){
                $("#tip").text("新站点的 到站时间 比已有站点最大时间还早");
                return;
            }

            var no = $("#stationBody").children().length+1;

            var stationName = $("#stationSelect").val();

            if(trainAdd.stations.has(stationName)){
                $("#tip").text("站点重复");
                return;
            }

            $("#stationBody").append('<tr><td>'+no+'</td><td>'+stationName+'</td><td>第<span>'+daoDay+'</span>天 <span>'+daoTime+'</span></td><td>第<span>'+chuDay+'</span>天 <span>'+chuTime+'</span></td></tr>');

            trainAdd.stations.set(stationName,"");
            trainAdd.maxTime=(chuDay+' '+chuTime);

            function getMin(dayNum,minstr){
                var hourMin = minstr.split(":");
                var h = parseInt(hourMin[0]);
                var m = parseInt(hourMin[1]);
                return (dayNum-1)*24*60+h*60+m;
            }

            trainAdd.stationData.push({"id":no,"stationName":stationName,"arriveMin":getMin(daoDay,daoTime),"leaveMin":getMin(chuDay,chuTime)});

            // console.log(JSON.stringify(trainAdd.stationData));

        },
        save:function (){
            $("#tip").text(" ").append("<span>&nbsp;</span>");;
            var trainName = $("#trainName").val();
            if(trainName==''){
                $("#tip").text("车次未填");
                return;
            }
            if(trainAdd.stationData.length<2){
                $("#tip").text("站点数量应该>=2");
                return;
            }
            if(trainAdd.stationData.length>20){
                $("#tip").text("站点最多20个");
                return;
            }
            if(trainAdd.carData.length<1){
                $("#tip").text("车厢数应该>=1");
                return;
            }
            $.post("/admin/addtrain",{"trainName":trainName,"stationJson":JSON.stringify(trainAdd.stationData),"carJson":JSON.stringify(trainAdd.carData)},function (data,status,xhr){
                if(data.code==10000){
                    trainShow.init();
                }else if(data.code==10001){
                    $("#tip").text("车次已被占用");
                }else{
                    $("#tip").text("添加失败");
                    console.log(data.msg)
                }
            },"json");
        },
        init2:function (station_arr){
            function genStationSelect(arr){
                return '<select id="stationSelect">'+arr.map(function (x){
                    return '<option>'+x+'</option>';
                }).join(" ") +'</select>';
            }

            var ccc = `
                <div style="text-align:center">
                    <div style="display: inline-block;vertical-align:top;padding: 5px;">
                        <table class="pure-table"> <thead> <tr> <th>#</th> <th>站点</th> <th>到站时间</th> <th>发车时间</th> </tr> </thead>
                        <tbody id="stationBody">
                        </tbody> </table>
                        <hr>
                        <div>
                            站点:`+genStationSelect(station_arr)+`
                            <br>
                            到站时间: 第<input id="daoDay" type="number" style="width: 30px;" required value="1">天，<input id="daoTime" type="time" required>
                            <br>
                            发车时间: 第<input id="chuDay" type="number" style="width: 30px;" required value="1">天，<input id="chuTime" type="time" required>
                            <br>
                            <button id="addStation" style="margin-top: 5px;" onclick="trainAdd.addStation()">添加</button>
                        </div>
                    </div>
                    <div style="display: inline-block;vertical-align:top;padding: 5px;">
                        <table class="pure-table"> <thead> <tr> <th>#</th> <th>座位类型</th> <th>数量</th> </tr> </thead>
                        <tbody id="seatBody">
                        </tbody> </table>
                        <hr>
                        <div>
                            类型:<select id="seatTypeSelect">
                                <option>商务座</option>
                                <option>一等座</option>
                                <option>二等座</option>
                                <option>硬卧</option>
                                <option>软卧</option>
                                <option>硬座</option>
                                <option>无座</option>
                            </select>
                            <br/>
                            数量:
                            <input id="seatNum" type="number" style="width: 50px;" required>
                            <br/>
                            <button id="addCar" style="margin-top: 5px;" onclick="trainAdd.addCar()">添加</button>
                        </div>
                    </div>
                </div>
            `;

            var a= '<div  style="width: 100%;background-color: #e5eecc;border: 1px solid #c3c3c3;">车次：<input id="trainName" type="text" style="margin-left:10px;width:60px;"></div>';
            var b = `
                <div style="width: 100%;background-color: #e5eecc;border: 1px solid #c3c3c3">`
                +ccc+`
                </div>
                <button style="margin-top: 5px;" onclick="trainAdd.save()">保存</button>
            `;

            $("#opBox").append(a+b);

        },
    };


    var trainShow = {
        init_ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="opBox"></div>
        `,
        init:function (){
            var p = this;
            $("#mainbox").children().remove();

            $("#mainbox").append(this.init_ele);

            trainShow.omg={}
            $.get("/admin/getalltrain",p.show,"json");
        },
        show: function (data,status,xhr){
            if(data.code==10000){
                $("#opBox").append('<div id="trainShowOpDiv" style="width: 100%;"><button style="text-decoration: none;" href="#" onclick="trainAdd.init();return false" >添加车次</button></div><br/>');

                if(data.data.length<1){
                    $("#opBox").append("没有车次");
                    return;
                }else{
                    trainShow.omg=data.data;
                    $("#trainShowOpDiv").append(`
                        <div style="float: right">
                            <button style="text-decoration: none;" href="#" onclick="trainShow.exeAll();return false" >执行全部车次</button>
                        </div>`);
                }
                function srcDst(d){
                    var stationObj =   JSON.parse(d.stationJson);
                    return '('+stationObj[0].stationName+'->'+stationObj[stationObj.length-1].stationName+')';
                }
                var ele_arr = data.data.map(function (d){
                    var a= '<div id="t_'+d.trainName+'" class="trainHead" style="width: 100%;background-color: #e5eecc;border: 1px solid #c3c3c3;">'+d.trainName+" "+srcDst(d)+'</div>';
                    var b = '<div id="desc_'+d.trainName+'" style="display:none;width: 100%;background-color: #e5eecc;border: 1px solid #c3c3c3">'+trainShow.showDetail(d)+'</div>';
                    return a+b;
                });
                $("#opBox").append('<div style="width: 650px;">'+ele_arr.join(" ")+'</div>');
                $(".trainHead").click(function (){
                    var n = $(this).attr('id').split('_')[1];
                    var actid = "desc_"+n;
                    $("#"+actid).slideToggle("fast");
                });
            }else{
                $("#tip").text("获取车次失败");
                console.log(data.msg)
            }
        },
        showDetail:function (d){
            var stationObj =   JSON.parse(d.stationJson);
            var carObj = JSON.parse(d.carJson);

            function ttt(min){
                var h=Math.floor(min/60);
                var m=min%60;

                return h+' 时 '+m+' 分';
            }

            var station_head = '<table class="pure-table"> <thead> <tr> <th>#</th> <th>站点</th> <th>到站时间</th> <th>发车时间</th> </tr> </thead> <tbody>';
            var station_end = '</tbody> </table>';

            var station_body = stationObj.map(function (d,index,arr){
                var no = index+1;
                var odd = no%2==0?'class="pure-table-odd"':''
                return '<tr '+odd+'> <td>'+no+'</td> <td>'+d.stationName+'</td> <td>'+ttt(d.arriveMin)+'</td> <td>'+ttt(d.leaveMin)+'</td> </tr>';
            }).join(" ");

            var car_head = '<table class="pure-table"> <thead> <tr> <th>#</th> <th>座位类型</th> <th>数量</th> </tr> </thead> <tbody>';
            var car_end = '</tbody> </table>';

            var car_body = carObj.map(function (d,index,arr){
                var no = index+1;
                var odd = no%2==0?'class="pure-table-odd"':''
                return '<tr '+odd+'> <td>'+no+'</td> <td>'+d.seatType+'</td> <td>'+d.seatNum+'</td> </tr>';
            }).join(" ");

            var op_ele = `
                <div style="padding: 5px;">
                <button style="margin-left:5px;" onclick="trainShow.del(`+d.id+',\''+d.trainName+`\')">删除</span></button>
                <button style="margin-left:5px;" onclick="trainShow.exe(\'`+d.trainName+`\')">执行</span></button>
                </div>
            `;

            return '<div style="text-align:center"><div style="display: inline-block;vertical-align:top;padding: 5px;">'+station_head+station_body+station_end+'</div><div style="display: inline-block;vertical-align:top;padding: 5px;">'+car_head+car_body+car_end+'</div>'+op_ele+'</div>';
        },
        del:function (id,trainName){
            var isdel = confirm("确定要删除 "+trainName+"么？");
            if(!isdel){
                return;
            }
            $.get("/admin/deltrain?id="+id,function (data,status,xhr){
                if(data.code==10000){
                    trainShow.init();
                }else{
                    $("#tip").text("删除车次失败");
                    console.log(data.msg)
                }
            },"json");
        },
        exe:function (d){
            exeTrainGen.init(d);
        },
        exeAll:function (){
            exeTrainGenBatch.init(trainShow.omg)
        }
    };

    var exeTrainGenBatch = {
        init_ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="opBox"></div>
        `,
        init:function (data){
            var p = this;
            $("#mainbox").children().remove();

            $("#mainbox").append(this.init_ele);

            $("#opBox").append('<h3>批量生成执行车次</h3><hr/>');


            $("#opBox").append('执行日期：<input type="date" id="exeDate" onchange="exeTrainGenBatch.setExeDate()"><br/>')
            $("#opBox").append('卖票时间：<input type="datetime-local" id="saleTs" ><br/>')
            $("#opBox").append('<button onclick="exeTrainGenBatch.add()">确定</button>')

            $("#opBox").append('<hr/>');
            var trains = data.map(function (d){
                var trainName = d.trainName;
                return '<tr><td>'+trainName+'</td><td></td></tr>'
            }).join(" ")
            $("#opBox").append('<table>'+trains+'</table>');

        },
        setExeDate:function (){
            if($("#saleTs").val()==''){
                var x = new Date(Date.parse($("#exeDate").val())-15*24*60*60*1000+9*60*60*1000);
                var omg = x.toISOString().substring(0,16);
                $("#saleTs").val(omg);
            }
        },
        add:function (){
            $("#tip").text(" ").append("<span>&nbsp;</span>");

            var trainName = $("#trainName").val();
            var exeDateS = $("#exeDate").val();
            var saleTsS = $("#saleTs").val();

            if(exeDateS==''){
                $("#tip").text("执行日期未填");
                return;
            }
            if(saleTsS==''){
                $("#tip").text("卖票时间未填");
                return;
            }
            if(exeDateS<saleTsS){
                $("#tip").text("卖票时间晚于执行时间");
                return;
            }
            var saleTs = Date.parse(saleTsS);
            console.log('saleTs '+saleTsS+' '+saleTs);
            $("tr").each(function (e){
               $(this).children().last().append("<img width=\"20\" height=\"20\" src=\"https://media.tenor.com/On7kvXhzml4AAAAj/loading-gif.gif\">")
            });
            exeTrainGenBatch.addImp($("tr").first(),exeDateS,saleTs);
        },
        addImp:function (e,exeDateS,saleTs){
            var trainName = e.children().first().text();
            $.post("/admin/addexetrain",{"trainName":trainName,"exeDate":exeDateS,"saleTs":saleTs},function (data,status,xhr){
                if(data.code==10000){
                    e.children().last().text("添加成功");
                }else{
                    e.children().last().text("添加失败");
                }
                nextTr = e.next();
                if(nextTr.length>0){
                    exeTrainGenBatch.addImp(nextTr,exeDateS,saleTs);
                }else{
                    setTimeout(function (){
                        alert("批量生成执行车次完成");
                        exeTrainShow.init();
                    },500);

                }
            },"json");
        },
    };

    var exeTrainGen = {
        init_ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="opBox"></div>
        `,
        init:function (trainName){
            var p = this;
            $("#mainbox").children().remove();

            $("#mainbox").append(this.init_ele);

            $("#opBox").append('<h3>生成执行车次</h3><hr/>');

            $("#opBox").append('车次：<input type="text" id="trainName" style="width:60px" readonly value="'+trainName+'" ><br/>')
            $("#opBox").append('执行日期：<input type="date" id="exeDate" onchange="exeTrainGen.setExeDate()"><br/>')
            $("#opBox").append('卖票时间：<input type="datetime-local" id="saleTs" ><br/>')
            $("#opBox").append('<button onclick="exeTrainGen.add()">确定</button>')

        },
        setExeDate:function (){
            if($("#saleTs").val()==''){
                var x = new Date(Date.parse($("#exeDate").val())-15*24*60*60*1000+9*60*60*1000);
                var omg = x.toISOString().substring(0,16);
                $("#saleTs").val(omg);
            }
        },
        add:function (){
            $("#tip").text(" ").append("<span>&nbsp;</span>");

            var trainName = $("#trainName").val();
            var exeDateS = $("#exeDate").val();
            var saleTsS = $("#saleTs").val();

            if(exeDateS==''){
                $("#tip").text("执行日期未填");
                return;
            }
            if(saleTsS==''){
                $("#tip").text("卖票时间未填");
                return;
            }
            if(exeDateS<saleTsS){
                $("#tip").text("卖票时间晚于执行时间");
                return;
            }
            var saleTs = Date.parse(saleTsS);
            console.log('saleTs '+saleTsS+' '+saleTs);
            $.post("/admin/addexetrain",{"trainName":trainName,"exeDate":exeDateS,"saleTs":saleTs},function (data,status,xhr){
                if(data.code==10000){
                    exeTrainShow.init();
                }else{
                    $("#tip").text("添加失败");
                    console.log(data.msg)
                }
            },"json");
        }
    };

    var exeTrainShow = {
        init_ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="opBox"></div>
        `,
        init:function (){
            var p = this;
            $("#mainbox").children().remove();

            $("#mainbox").append(this.init_ele);

            $("#opBox").append('<h3>执行车次</h3><hr/>');

            $.get("/admin/getallexetrain",exeTrainShow.show,"json");

        },
        show : function (data,status,xhr){
            if(data.code==10000){
                if(data.data.length<1){
                    $("#opBox").append("没有执行车次");
                    return;
                }
                var dateMap = new Map();
                const dates = new Set();
                data.data.forEach(function (d){
                    if(!dateMap.has(d.exeDate)){
                        dateMap.set(d.exeDate,[d]);
                    }else{
                        dateMap.get(d.exeDate).push(d);
                    }
                    dates.add(d.exeDate);
                });
                // console.log("AAA "+Array.from(dates).sort().reverse())
                // console.log("BBB "+dateMap.size)

                function getTitle(d){
                    var stationObj =   JSON.parse(d.stationJson);
                    console.log(JSON.stringify(d))
                    var haha = '#'+d.id+' <div style="width: 60px;display: inline-block">'+d.trainName+'</div> <span style="margin-right: 5px">'+d.leaveMin+'</span>'
                        +' ('+stationObj[0].stationName+'->'+stationObj[stationObj.length-1].stationName+')'
                        + '<div style="display: inline-block;float: right">开始卖票时间: '+new Date(d.saleTs+8*60*60*1000).toISOString().substring(0,16)+'</div>';
                    return haha;
                }


                $("#opBox").append('<div id="listBox" style="width: 650px;"></div>');

                Array.from(dates).sort().reverse().forEach(function (d){
                    $("#listBox").append('<br/>'+d+'<br/>');
                    var arr = dateMap.get(d).map(function (d){
                        //
                        var stationObj =   JSON.parse(d.stationJson);
                        var mins = stationObj[0].leaveMin;
                        var hh = Math.floor(mins/60)
                        var mm = mins%60;
                        d.leaveMin = num2(hh)+":"+num2(mm)
                        return d;
                    });
                    var arr_sorted = arr.sort(function (a,b){
                       if(a.leaveMin==b.leaveMin){
                           return 0;
                       } else if(a.leaveMin<b.leaveMin){
                           return -1;
                       } else {
                           return 1;
                       }
                    });
                    var ele_arr = arr_sorted.map(function (d){  // [{id,trainName,exeDate,saleTs,stationJson,carJson}]
                        var a= '<div class="trainHead" style="width: 100%;background-color: #e5eecc;border: 1px solid #c3c3c3;">'+getTitle(d)+'</div>';
                        var b = '<div style="display:none;width: 100%;background-color: #e5eecc;border: 1px solid #c3c3c3">'+exeTrainShow.showDetail(d)+'</div>';
                        return a+b;
                    });
                    $("#listBox").append(ele_arr);
                });

                $(".trainHead").click(function (){
                    $(this).next().slideToggle("fast");
                });
            }else{
                $("#tip").text("获取执行车次失败");
                console.log(data.msg)
            }
        },
        showDetail:function (d){
            //[{id,trainName,exeDate,saleTs,stationJson,carJson}]
            // stationJson  [{id,stationName,arriveMin,leaveMin}]
            // carJson  [{id,seatType,seatNum}]
            var stationObj =   JSON.parse(d.stationJson);
            var carObj = JSON.parse(d.carJson);

            function timeF(item){
                var baseTs = Date.parse(d.exeDate);
                var t = baseTs+item*60*1000;
                var omg = new Date(t).toISOString().substring(0,16).split('T');
                return omg[0]+'<br/>'+omg[1];
            }
            // stationJson  [{id,stationName,arriveMin,leaveMin}]
            var stationC = {
                "headNames":[,"#","站点","到站时间","发车时间"],
                "dNames":[{"n":"id"},{"n":"stationName"},{"n":"arriveMin","f":timeF},{"n":"leaveMin","f":timeF}]
            };
            var stationT = arrToTable(stationObj,stationC);

            // carJson  [{id,seatType,seatNum}]
            var carC = {
                "headNames":[,"#","座位类型","数量"],
                "dNames":[{"n":"id"},{"n":"seatType"},{"n":"seatNum"}]
            };
            var carT = arrToTable(carObj,carC);

            var op_ele = `
                <div style="padding: 5px;">
                <button style="margin-left:5px;" onclick="exeTrainShow.del(`+d.id+`,\'`+d.trainName+`\',\'`+d.exeDate+`\')">删除</button>
                <button style="margin-left:5px;" onclick="exeTrainShow.addcar()">加挂</button>
                </div>
            `;

            return '<div style="text-align:center"><div style="display: inline-block;vertical-align:top;padding: 5px;">'+stationT+'</div><div style="display: inline-block;vertical-align:top;padding: 5px;">'+carT+'</div>'+op_ele+'</div>';
        },
        del:function (id,trainName,exeDate){
            var isdel = confirm("确定要删除 "+exeDate+' 的 '+trainName+"么？");
            if(!isdel){
                return;
            }
            $.get("/admin/delexetrain?id="+id,function (data,status,xhr){
                if(data.code==10000){
                    exeTrainShow.init();
                }else{
                    $("#tip").text("删除执行车次失败");
                    console.log(data.msg)
                }
            },"json");
        },
        addcar:function (){
            alert("暂时不支持");
        },
    };

    function arrToTable(data,c){
        // t_class
        // headNames [str]  dNames [{n,f}]
        var t_class = c.t_class===undefined?'class=pure-table':('class="'+c.t_class+'"');
        var t_head = '<table '+t_class+'> <thead> <tr> '+c.headNames.map(function (n){return '<th>'+n+'</th>'}).join(' ')+' </tr> </thead> <tbody>';
        var t_end = '</tbody> </table>';

        function omg(d){
            return c.dNames.map(function (nf){
                var raw = d[nf.n];
                if(nf.f===undefined){
                    return '<td>'+raw+'</td>';
                }else{
                    return '<td>'+nf.f(raw)+'</td>';
                }
            }).join(' ');
        }
        var t_body = data.map(function (d,index,arr){
            var no = index+1;
            var odd = no%2==0?'class="pure-table-odd"':''
            return '<tr '+odd+'> '+omg(d)+' </tr>';
        }).join(" ");
        return t_head+t_body+t_end;
    };

    function x2 (d){
        return d*2;
    }
    var xxx = arrToTable([{"a":1,"b":2,"c":3},{"a":4,"b":5,"c":6}],{"t_class":"pure-table","headNames":[,"a","b","c"],"dNames":[{"n":"a","f":x2},{"n":"b","f":x2},{"n":"c","f":x2}]});


    var ticketQuery = {
        init_ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="opBox">
        </div>
        `,
        shareData:{},
        init:function (act){
            var p = this;
            $("#mainbox").children().remove();

            $("#mainbox").append(this.init_ele);

            $.get("/getallstation",function (data,status,xhr){
                if(data.code==10000){
                    var cont = ticketQuery.content(data.data);
                    $("#opBox").append(cont);
                    var startPos = getCookie('startPos');
                    if(startPos!=''){
                        $("#startPos").val(startPos);
                    }
                    var endPos = getCookie('endPos');
                    if(endPos!=''){
                        $("#endPos").val(endPos);
                    }
                    var startDate = getCookie('startDate');
                    if(startDate!=''){
                        $("#startDate").val(startDate);
                    }

                }else if(data.code==302){
                    if(act==1){
                        window.location.pathname='/login'
                    }else {
                        $("#opBox").append('先<a href="/login">登录</a>，再订票');
                    }
                }else{
                    $("#tip").text("获取车站信息失败");
                    console.log(data.msg)
                }
            },"json");

        },
        content: function (stationArr){
            var option = stationArr.map(function (item){
                return '<option>'+item+'</option>';
            }).join(' ');
            var ele=`
                    <div style="border: 1px solid #298cce;background: #eef1f8;">
                        <div class="queryItem">出发地<br/><select id="startPos" onchange="setCookie('startPos',this.value,300)">`+option+`</select></div>
                        <div class="queryItem">目的地<br/><select id="endPos" onchange="setCookie('endPos',this.value,300)">`+option+`</select></div>
                        <div class="queryItem">出发日<br/><input type="date" id="startDate" onchange="setCookie('startDate',this.value,300)"></div>
                        <div class="queryItem"><button id="qseat" onclick="ticketQuery.qseat()">查询</button></div>
                    </div>
                    <hr/>
                    <div>
                        <table class="pure-table" style="font-size: 12px;"> <thead style="background: #eef1f8;">
                            <tr>
                                <th>车次</th> <th>出发站<br/>到达站</th> <th>出发时间<br/>到达时间</th> <th>历时</th> <th>商务座</th> <th>一等座</th> <th>二等座</th> <th>硬卧</th> <th>软卧</th> <th>硬座</th> <th>无座</th> <th></th>
                            </tr>
                            </thead><tbody></tbody>
                        </table>
                    </div>
                    <div id="tip2" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
            `;
            return ele;
        },
        qseat:function (){
            $("#tip").text(" ").append("<span>&nbsp;</span>");
            $("#tip2").text(" ");
            var startPos = $("#startPos").val();
            var endPos = $("#endPos").val();
            var startDate = $("#startDate").val();

            if(startDate==''){
                $("#tip").text("出发日未选");
                return;
            }
            if(startPos==endPos){
                $("#tip").text("出发地、目的地不能相同");
                return;
            }
            $.get("/querySeat?startDate="+startDate+'&startPos='+encodeURIComponent(startPos)+'&endPos='+encodeURIComponent(endPos),function (data,status,xhr){
                if(data.code==10000){
                    ticketQuery.showSeat(data.data);
                    ticketQuery.shareData.seat=data.data;
                    if(data.data.length<1){
                        $("#tip2").text("没有查询到车次");
                        console.log(data.msg)
                    }
                }else{
                    $("#tip").text("获取车站信息失败");
                    console.log(data.msg)
                }
            },"json");
        },
        showSeat:function (data){
            function nullTohh(somed){
                if(somed==null){
                    return '--';
                }else{
                    return somed;
                }
            }
            function num2(num){
                if(num<10){
                    return '0'+num.toString();
                }else{
                    return num.toString();
                }
            }
            function baseTr(che,no){

                function tFormat(ts){
                    var dt = new Date(ts);
                    return num2(dt.getHours())+':'+num2(dt.getMinutes());
                }
                function durFormat(ms){
                    var min=Math.floor(ms/1000/60);
                    var h=Math.floor(min/60);
                    var m=min%60;
                    return num2(h)+':'+num2(m);
                }

                var odd = no%2==0?'class="pure-table-odd"':'';
                var ret = `<tr `+odd+`> `
                    +`<td class="doTrainName" >`+che.trainName+`</td>`
                    +`<td>`+che.leaveStation+`<br/>`+che.arriveStation+`</td>`
                    +`<td>`+tFormat(che.leaveTs)+`<br/>`+tFormat(che.arriveTs)+`</td>`
                    +`<td>`+durFormat(che.arriveTs-che.leaveTs)+`</td>`
                    +`<td class="doPrice">`+nullTohh(che.seatANum)+`</td>`
                    +`<td class="doPrice">`+nullTohh(che.seatBNum)+`</td>`
                    +`<td class="doPrice">`+nullTohh(che.seatCNum)+`</td>`
                    +`<td class="doPrice">`+nullTohh(che.seatDNum)+`</td>`
                    +`<td class="doPrice">`+nullTohh(che.seatENum)+`</td>`
                    +`<td class="doPrice">`+nullTohh(che.seatFNum)+`</td>`
                    +`<td>`+nullTohh(che.seatGNum)+`</td>`
                    +`<td><a href="#" id="tiketBtn" class="tiketBtn" onclick="ticketQuery.buy(`+no+`);return false">订票</a></td>`
                    +` </tr>`;
                return ret;
            }
            function priceTr(che){
                function priceFormat(p){
                    if(p==null){
                        return '';
                    }else{
                        return '<span style="color: #fc8302;">¥'+p+'</span';
                    }
                }
                var ret = `<tr style="display: none;"> `
                    +`<td></td>`
                    +`<td></td>`
                    +`<td></td>`
                    +`<td></td>`
                    +`<td>`+priceFormat(che.seatAPrice)+`</td>`
                    +`<td>`+priceFormat(che.seatBPrice)+`</td>`
                    +`<td>`+priceFormat(che.seatCPrice)+`</td>`
                    +`<td>`+priceFormat(che.seatDPrice)+`</td>`
                    +`<td>`+priceFormat(che.seatEPrice)+`</td>`
                    +`<td>`+priceFormat(che.seatFPrice)+`</td>`
                    +`<td>`+priceFormat(che.seatGPrice)+`</td>`
                    +`<td></td>`
                    +` </tr>`;
                return ret;
            }
            function timeTr(che){
                function timeF(minoffset){
                    var h=Math.floor(minoffset/60);
                    var m=minoffset%60;
                    return num2(h)+':'+num2(m);
                }
                var stationObj = JSON.parse(che.stationJson);
                var stationC = {
                    "headNames":[,"站序","站名","到站时间","出发时间"],
                    "dNames":[{"n":"id"},{"n":"stationName"},{"n":"arriveMin","f":timeF},{"n":"leaveMin","f":timeF}]
                };
                var stationT = arrToTable(stationObj,stationC);

                return '<tr  style="display: none;"><td colspan="12">'+stationT+'</td></tr>';
            }
            var trs = data.map(function (che,index,arr){
                return baseTr(che,index+1)+priceTr(che,index+1)+timeTr(che,index+1);
            }).join(' ');
            // console.log(trs);
            $("tbody").children().remove();
            $("tbody").append(trs);

            $(".doTrainName").click(function (){
                $(this).parent().next().next().slideToggle("fast");
            });
            $(".doPrice").click(function (){
                $(this).parent().next().slideToggle("fast");
            });
        },
        buy:function (no){
            var seatInfo = ticketQuery.shareData.seat[no-1];
            createOrder.init(seatInfo);
        }
    };

    var createOrder ={
        init_ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="opBox">
        </div>
        `,
        shareData:{},
        init:function (seatInfo){
            createOrder.shareData.seatInfo=seatInfo;
            var p = this;
            $("#mainbox").children().remove();

            $("#mainbox").append(this.init_ele);

            $("#opBox").append('<h3>创建订单</h3><hr/>');


            var elea = `
            <br/>
            <div>
                <div style="display: inline-block;text-align: right;"><br>`+seatInfo.leaveStation+`<br/>[`+tsToMin(seatInfo.leaveTs)+`]</div>
                <div style="display: inline-block;vertical-align: top;">`+seatInfo.trainName+`<br> -----> </div>
                <div style="display: inline-block"><br>`+seatInfo.arriveStation+`<br/>[`+tsToMin(seatInfo.arriveTs)+`]</div>
            </div>
            <br/>
            `;

            $("#opBox").append(elea);

            $("#opBox").append('<div class="ccc" >坐席:'+createOrder.omg(seatInfo)+'<button style="margin-left: 10px;" onclick="createOrder.doCreateOrder()" >创建订单</button>');



        },
        doCreateOrder:function (){
            // 执行车次
            // 座位类型
            // 区间  id
            let exeTrainId=createOrder.shareData.seatInfo.exeTrainId;
            let leaveStationNo=createOrder.shareData.seatInfo.leaveStationNo;
            let arriveStationNo=createOrder.shareData.seatInfo.arriveStationNo
            var seatType = $("#seatTypeSelect").val().split('|')[0];

            $.post("/createorder",{"exeTrainId":exeTrainId,"leaveStationNo":leaveStationNo,"arriveStationNo":arriveStationNo,"seatType":seatType},function(data,status,xhr){
                if(data.code==10000){
                    createOrder.showPay(data.data.price,data.data.id)
                }else{
                    $("#tip").text("下单失败");
                    console.log(data.msg)
                }
            },"json");
        },
        omg:function (seatInfo){
            var pair = {"商务座":"A","一等座":"B","二等座":"C","硬卧":"D","软卧":"E","硬座":"F","无座":"G"};
            var ret = ['<select id="seatTypeSelect" style="margin-left: 10px;">'];
            for(var k in pair){
                var flag = pair[k];
                if(seatInfo['seat'+flag+'Num']>0){
                    ret.push('<option>'+k+'|￥'+seatInfo['seat'+flag+'Price']+'</option>');
                }
            }
            ret.push('</select>');
            return ret.join(' ')
        },
        showPay:function (price,id){
            $("#opBox").children().remove();
            $("#opBox").append('<h3>支付订单</h3><hr/>');
            $("#opBox").append('<div style="margin: 0 auto;width: fit-content;">￥'+price+'</div>');
            $("#opBox").append('<div style="margin: 0 auto;width: fit-content;"><img style="max-width: 228px;max-height: 228px;" id="qrimage" src="data:image/png;base64,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"></div>');
            $("#opBox").append('<div style="margin: 0 auto;width: fit-content;"><button onclick="createOrder.doPay('+id+')" >支付成功</button></div>');
        },
        doPay:function (orderId){
            $.get("/paysuccess?orderId="+orderId,function(data,status,xhr){
                if(data.code==10000){
                    orderShow.init(orderId);
                }else{
                    $("#tip").text("支付失败");
                    console.log(data.msg)
                }
            },"json");
        },
    };

    var orderShow = {
        init_ele:`
        <div id="tip" style="width:100%;margin-bottom: 1rem;color: red;">&nbsp;</div>
        <div id="opBox">
        </div>
        `,
        shareData:{},
        init:function (orderId){
            var p = this;
            $("#mainbox").children().remove();

            $("#mainbox").append(this.init_ele);

            $.get("/getmyorders",function (data,status,xhr){
                if(data.code==10000){
                    $("#opBox").append('<h3>订单</h3><hr/>');
                    var orderDiv = data.data.map(function (order){
                        console.log("AAA"+order.orderStatus)
                        return `
                            <div style="margin-bottom: 3px;border-radius: 5px;background-color: #4dc5fe;padding: 10px;">
                                <div>
                                    <div style="display: inline-block;text-align: right;">`+order.leaveStationName+`<br/>`+tsToMin(order.leaveTs)+`</div>
                                    <div style="display: inline-block;vertical-align: top;">`+order.trainName+`<br> -----> </div>
                                    <div style="display: inline-block">`+order.arriveStationName+`<br/>`+tsToMin(order.arriveTs)+`</div>
                                </div>
                                <div style="margin: 10px 0;">
                                    <span>`+seatTypeMap[order.seatType]+`</span>
                                    <span>`+num2(order.carNo)+`车`+num2(order.seatNo)+`号</span>
                                    <span style="float: right">￥`+order.price+` [`+orderStatusMap[order.orderStatus]+`]</span>
                                </div>
                                <div style="margin: 10px 0 0 auto;text-align: right">
                                    <button href="#" `+(order.orderStatus==0?' ':' disabled="disabled" ')+` onclick="createOrder.showPay(`+order.price+','+order.id+`);return false" >支付</button>
                                    <button href="#" `+(order.orderStatus==1?' ':' disabled="disabled" ')+` onclick="orderShow.refund(`+order.id+`);return false" >退票</button>
                                    <button href="#" `+((order.orderStatus==2||order.orderStatus==3)?' ':' disabled="disabled" ')+` onclick="orderShow.del(`+order.id+`);return false" >删除</button>
                                </div>
                            </div>
                        `;
                    }).join(' ');

                    if(orderDiv.length<1){
                        $("#opBox").text("目前没有订单");
                    }else {
                        $("#opBox").append(orderDiv);
                    }

                }else{
                    $("#tip").text("获取订单信息失败");
                    console.log(data.msg)
                }
            },"json");
        },
        refund:function (id){
            $.get("/refundticket?orderId="+id,function(data,status,xhr){
                if(data.code==10000){
                    orderShow.init(id);
                }else{
                    $("#tip").text("退票失败");
                    console.log(data.msg)
                }
            },"json");
        },
        del:function (id){
            if(confirm("真的要删除这个订单么？")){
                $.get("/deleteorder?orderId="+id,function(data,status,xhr){
                    if(data.code==10000){
                        orderShow.init(id);
                    }else{
                        $("#tip").text("删除失败");
                        console.log(data.msg)
                    }
                },"json");
            }
        },
    };

    var seatTypeMap = {1:"商务座",2:"一等座",3:"二等座",4:"硬卧",5:"软卧",6:"硬座",7:"无座"};
    var orderStatusMap = {0:"未支付",1:"已支付",2:"已退票",3:"已取消"};
    function num2(num){
        if(num<10){
            return '0'+num.toString();
        }else{
            return num.toString();
        }
    }
    function tsToMin(ts){

        return new Date(ts+8*60*60*1000).toISOString().substring(0,16);
        // var d = new Date(ts);
        // return d.getFullYear()+'年'+num2(d.getMonth())+'月'+num2(d.getDay())+'日'+num2(d.getHours())+':'+num2(d.getMinutes());
    }



</script>
<div class="nav">
    <div class="inb">
        <span class="textRight">12306S</span>
        <a href="#" id="tiketBtn" class="textRight tiketBtn" onclick="ticketQuery.init(1);return false">订票</a>
    </div>
    <div class="inb" style="float:right">
        <div class="inb" sec:authorize="!isAuthenticated()">
            <a class="textRight" href="/reg.html">注册</a>
            <a class="textRight" href="/login">登录</a>
        </div>
        <div class="inb" sec:authorize="isAuthenticated()">
            <div class="inb" sec:authorize="hasRole('admin')">
                <span class="textRight">|</span>
                <span class="textRight" >管理操作:</span>
                <a class="textRight" href="#" onclick="adminOp.init();return false" >管理Admin</a>
                <a class="textRight" href="#" onclick="stationOp.init();return false" >车站</a>
                <a class="textRight" href="#" onclick="trainShow.init();return false" >车次</a>
                <a class="textRight" href="#" onclick="exeTrainShow.init();return false" >执行车次</a>
                <span class="textRight">|</span>
            </div>
            <a class="textRight" href="#" onclick="orderShow.init(0);return false" >查看订单</a>
            <a class="textRight" href="#" onclick="chgpwd();return false">修改密码</a>
            <span class="textRight">|</span>
            <span class="textRight">
                <span sec:authentication="name" >
                </span>(<span th:text="${uid}" ></span>)
            </span>
            <a class="textRight" href="/logout">退出</a>
        </div>

    </div>
</div>
<hr/>

<div class="mainbox" id="mainbox">
</div>

<script>
    ticketQuery.init(0);
</script>

</body>
</html>